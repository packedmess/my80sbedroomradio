var stateType={init:0,first:1,second:2},objLen=function(t){var e,i=0;for(e in t)t.hasOwnProperty(e)&&i++;return i},all=function(t){var e,i;if(objLen(t)>0){i=!0;for(e in t)if(t.hasOwnProperty(e)&&!t[e]){i=!1;break}}else i=null;return i},any=function(t){var e,i=!0;if(objLen(t)>0){i=!1;for(e in t)if(t.hasOwnProperty(e)&&t[e]){i=!0;break}}else i=null;return i},StatusWidget=function(t,e,i,r,s){this.params={},this.server=e,this.code="",this.data={djOnair:null,history:null,listeners:null},this.positionEl=$(r),this.host=i,this._reqCounterRunner=0,this._reqCounterComplete=0,this.handler=null,this._spinner='<img src="'+this.host+'/media/static/images/ajax-loader.gif" />',this.language=s,this._init(t)};StatusWidget.prototype={defaults:{djImage:!1,djName:!0,listenersNum:!0,trackCurrent:!0,history:!0,widgetWidth:350},tm:1e4,template:"{{if data.djOnair }}${data.djOnair.metadata}{{/if}}",api:{djOnair:"/api/djs/?server={{server}}&active=true&connected=true&on_air=true&limit=1",history:"/api/history/?server={{server}}&limit=10",listeners:"/api/channels/?server={{server}}&limit=100"},api_relation:{djOnair:["djImage","djName","trackCurrent"],history:["history"],listeners:["listenersNum"]},data_table:{djOnair:"getDJ",history:"getHistory",listeners:"getListeners"},_init:function(t){$.template("template",this.template);var e;for(e in this.defaults)this.defaults.hasOwnProperty(e)&&(this.params[e]=t.hasOwnProperty(e)?t[e]:!1);this.positionEl.html(this.spinner),this.getData()},getDJ:function(t){this.data.djOnair=t.objects.length?t.objects[0]:null},getHistory:function(t){var e,i,r=[];for(e in t.objects)t.objects.hasOwnProperty(e)&&(i=t.objects[e],dttm=i.dttm.replace(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):\d{2}/,function(t,e,i,r,s,n){return s+":"+n}),r.push({dj_name:i.dj_name,metadata:i.metadata,dttm:dttm,n_listeners:i.n_listeners}));this.data.history=r},getListeners:function(t){var e,i=0;for(e in t.objects)t.objects.hasOwnProperty(e)&&(i+=t.objects[e].listeners_air);this.data.listeners=i},getData:function(){var t;for(t in this.api_relation)if(this.api_relation.hasOwnProperty(t)){var e,i,r=[];i=this.api_relation[t];for(e in i)r.push(this.params[i[e]]);any(r)&&(this._reqCounterRunner++,this._pushRequest(t))}},_pushRequest:function(t){var e=this;$.ajax({url:this.host+this.api[t].replace("{{server}}",this.server),type:"GET",dataType:"jsonp",complete:function(){e._reqCounterComplete++,e._reqCounterRunner===e._reqCounterComplete&&(e._reqCounterRunner=0,e._reqCounterComplete=0,e.render())},success:function(i){e[e.data_table[t]](i)}})},render:function(){this.renderInit();var t;for(t in this.data)this.data.hasOwnProperty(t)&&(this.data[t]=null)},renderInit:function(){this.code=$.tmpl("template",{params:this.params,data:this.data,host:this.host,language:this.language}),this.positionEl.html($(this.code));var t=this;this.handler=setTimeout(function(){t.getData()},t.tm)},destroy:function(){clearTimeout(this.handler),this.positionEl.empty()}};